!function(t){t.fn.lifoidchat=function(e){var a,n,s=null,o=0,l=function(t){"undefined"!=typeof console&&void 0!==console.error&&console.error("LifoidChat [ERROR]: "+t)},r=function(t){e.debug&&"undefined"!=typeof console&&void 0!==console.error&&console.debug("LifoidChat [DEBUG]: "+t)},c=function(t){if(!e.auth)return t({lang:e.lang,url:e.url,id:"me",username:"me",access_token:"access_token"});session=function(t){var e=new AWSCognito.CognitoIdentityServiceProvider.CognitoAuth(t);return e.userhandler={onSuccess:function(){r("session open")},onFailure:l},e.getSession(),e}(e.authData);return t({lang:e.lang,url:e.url,id:session.username,username:session.username,access_token:session.signInUserSession.accessToken.jwtToken})},d=function(t){return t.userId};new function(e,u){var m={debug:!1,data_from_session:c,userid_from_data:d};u="object"==typeof u?t.extend(m,u):m;var p=t('          <div class="panel panel-inverse">             <div class="panel-body" data-scrollbar="true" data-height="100%" style="padding-bottom:100px;">               <ul class="chats"></ul>             </div>           </div>'),f={},h=p.find(".chats").eq(0),b=function(){return h.children().last().prop("date")},g=function(){var t=new Date;return t.toISOString().substr(0,19)+"."+t.getUTCMilliseconds()},v=function(e,a,n){var s=this;return s.id=e,s.username=a,s.color=n,s.chat=function(e,a){return new function(e,a,n,s,o,l){var r=this;if(r.$tpl="","message"==e){if(r.$tpl=t('              <li class="right">                 <a href="javascript:;" class="image"><img alt="" src="" /></a>                 <div class="message">                   <a href="javascript:;" class="name"></a>                   <span class="text"></span>                   <span class="date-time">just now</span>                 </div>              </li>'),o){if(null!=s.attachments)for(i=0;i<s.attachments.length;i++){if(null!=s.attachments[i].file_url&&r.$tpl.append('<a href="'+s.attachments[i].file_url+'" target="_blank" class="btn btn-primary m-t-5" style="margin-left:70px;">'+s.attachments[i].text+"</a>"),null!=s.attachments[i].actions)if("menu_select"==s.attachments[i].actions[0].name)for(j=0;j<s.attachments[i].actions.length;j++)for(r.$tpl.append('<form class="form-input-flat m-t-5"></form>'),r.$tpl.find(".form-input-flat").append('<div class="form-group row" style="margin-left:70px;"><select class="form-control col-sm-4 lifoid-ms"><option value="">Please select an option</option></select></div>'),k=0;k<s.attachments[i].actions[j].options.length;k++)r.$tpl.find(".form-control").append('<option value="'+s.attachments[i].actions[j].options[k].value+'">'+s.attachments[i].actions[j].options[k].text+"</option>");else for(r.$tpl.append('<div class="btn-group-vertical m-t-5" style="margin-left:70px;"></div>'),j=0;j<s.attachments[i].actions.length;j++)r.$tpl.find(".btn-group-vertical").append('<button type="button" class="btn btn-primary lifoid-qr" data-value="'+s.attachments[i].actions[j].value+'">'+s.attachments[i].actions[j].name+"</button>");if(null!=s.attachments[i].table){for(r.$attachment=t('                      <div class="panel panel-info m-t-5">                        <div class="panel-heading">                        <h4 class="panel-title">'+s.attachments[i].table.title+'</h4>                        </div>                        <div class="table-responsive">                          <table class="table table-striped lifoid-edit-table" data-name="'+s.attachments[i].table.name+'" data-columns="'+s.attachments[i].table.columns.join()+'" data-types="'+s.attachments[i].table.types.join()+"\" data-rows='"+JSON.stringify(s.attachments[i].table.rows)+"' data-title=\""+s.attachments[i].table.title+'" style="margin-bottom:4px;">                            <thead><tr class="info"><th></th></tr></thead>                            <tbody>                            </tbody>                          </table>                        </div>                      </div>                      '),j=0;j<s.attachments[i].table.columns.length;j++)r.$attachment.find("thead > tr").append('<th class="text-center">'+s.attachments[i].table.columns[j]+"</th>");for(j=0;j<s.attachments[i].table.rows.length;j++)for(r.$attachment.find("tbody").append('<tr><td class="text-center"><button class="btn btn-xs btn-danger" type="button"><i class="fa fa-minus"></i></button></td></tr>'),k=0;k<s.attachments[i].table.columns.length;k++)column=s.attachments[i].table.columns[k],"Date"==s.attachments[i].table.types[k]?r.$attachment.find("tbody > tr:last").append('                          <td data-value="'+moment().format("MM/DD/YYYY")+'">                          <input class="daterange-singledate form-control" type="text" name="'+column+'" value="'+moment().format("MM/DD/YYYY")+'" />                          </td>                          '):r.$attachment.find("tbody > tr:last").append("<td>"+s.attachments[i].table.rows[j][column]+"</td>");r.$attachment_btn=t('                      <div class="btn-group m-t-5">                        <button class="btn btn-primary add-row btn-sm" type="button"><i class="fa fa-plus"></i></button>                        <button class="btn btn-primary send-table btn-sm" type="button"><i class="fa fa-send"></i></button>                      </div>                      '),r.$tpl.append(r.$attachment),r.$tpl.append(r.$attachment_btn),r.$tpl.find("table").editableTableWidget({editor:t('<input class="table-input">')}),r.$tpl.find(".daterange-singledate").each(function(){var e=this;t(this).daterangepicker({start:moment(),singleDatePicker:!0,showDropdowns:!0,drops:"up",locale:{format:"MM/DD/YYYY"}},function(a,n,i){selected_date=a.format("MM/DD/YYYY"),e.value=selected_date,t(e.parentNode).attr("data-value",selected_date)})}),r.$tpl.on("click",".btn-danger",function(){this.parentNode.parentNode.remove()}),r.$tpl.on("click",".add-row",function(){var e=h.find(".lifoid-edit-table"),a=e.attr("data-types").split(","),n=e.attr("data-columns").split(","),i=JSON.parse(e.attr("data-rows"));for(e.find("tbody").append('<tr><td class="text-center"><button class="btn btn-xs btn-danger" type="button"><i class="fa fa-minus"></i></button></td></tr>'),k=0;k<a.length;k++)column=n[k],"Date"==a[k]?e.find("tbody > tr:last").append('                          <td data-value="'+moment().format("MM/DD/YYYY")+'">                          <input class="daterange-singledate form-control" type="text" name="'+column+'" value="'+moment().format("MM/DD/YYYY")+'" />                          </td>                          '):e.find("tbody > tr:last").append("<td>"+i[0][column]+"</td>");e.editableTableWidget({editor:t('<input class="table-input">')}),e.find(".daterange-singledate").each(function(){var e=this;t(this).daterangepicker({start:moment(),singleDatePicker:!0,showDropdowns:!0,drops:"up",locale:{format:"MM/DD/YYYY"}},function(a,n,i){selected_date=a.format("MM/DD/YYYY"),e.value=selected_date,t(e.parentNode).attr("data-value",selected_date)})})})}}r.$tpl.addClass("left").removeClass("right"),r.$tpl.find("img").attr("src",u.lifoidAvatar)}else if(r.$tpl.find("img").attr("letters","Me"),null!=s.attachments)for(i=0;i<s.attachments.length;i++)if(null!=s.attachments[i].table){for(r.$attachment=t('                    <div class="panel panel-info m-t-5">                      <div class="panel-heading">                      <h4 class="panel-title">'+s.attachments[i].table.title+'</h4>                      </div>                      <div class="table-responsive">                        <table class="table table-striped">                          <thead><tr class="info"></tr></thead>                          <tbody></tbody>                        </table>                      </div>                    </div>                      '),j=0;j<s.attachments[i].table.columns.length;j++)r.$attachment.find("thead > tr").append('<th class="text-center">'+s.attachments[i].table.columns[j]+"</th>");for(j=0;j<s.attachments[i].table.rows.length;j++)for(r.$attachment.find("tbody").append("<tr></tr>"),k=0;k<s.attachments[i].table.columns.length;k++)column=s.attachments[i].table.columns[k],r.$attachment.find("tbody > tr:last").append("<td>"+s.attachments[i].table.rows[j][column]+"</td>");r.$tpl.append(r.$attachment)}-1!=a.indexOf("Google")?r.$tpl.find(".name").text("me").html():r.$tpl.find(".name").text(a).html(),r.$tpl.find(".text").text(s.text).html(),r.$tpl.find(".date-time").text(prettyDate(n)).html(),r.$tpl.prop("date",n)}h.append(r.$tpl),generateAvatars(l)}("message",s.username,a,e,s.id==u.lifoidId,s.color)},s};u.data_from_session(function(i){f[i.id]=new v(i.id,i.username,u.color),f[u.lifoidId]=new v(u.lifoidId,u.lifoidName,u.color),s=new function(e,a){var n=this;return n.lang=e.lang,n.url=e.url,n.access_token=e.access_token,n.username=e.username,n.lifoid_id=a,n.load=function(e,a,i){t.ajax({type:"POST",crossDomain:!0,url:n.url+"/messages",data:JSON.stringify({chatbot_id:n.lifoid_id,lang:n.lang,access_token:n.access_token,to_date:e,user:{username:n.username}}),contentType:"application/json",dataType:"json"}).done(function(t){a(t)}).fail(function(t,e){403==t.status&&(console.log(u.expiredUrl),window.location.href=u.expiredUrl),i("Cannot fetch Lifoid server")})},n.subscribe=function(e,a,i){setTimeout(function(){t.ajax({type:"POST",crossDomain:!0,url:n.url+"/messages",data:JSON.stringify({chatbot_id:n.lifoid_id,access_token:n.access_token,from_date:e,user:{username:n.username}}),contentType:"application/json",dataType:"json"}).done(function(t){t.length>0?a(t):n.subscribe(e,a,i)}).fail(function(t,e){403==t.status&&(window.location.href=u.expiredUrl),i("Cannot fetch Lifoid server")})},500)},n.publish=function(e,a,i){t.ajax({type:"POST",crossDomain:!0,url:n.url+"/webhook",data:JSON.stringify(e),contentType:"application/json"}).done(function(t){var e=t;n.subscribe(e,a,i)}).fail(function(t,s){403==t.status&&(window.location.href=u.expiredUrl),i("Cannot fetch Lifoid server"),setTimeout(function(){n.publish(e,a,i)},1e4)})},n}(i,u.lifoidId);var c=g();r("fetch:"+c);var d=function(e,a,n,o){var r=g();-1==n.indexOf("chatui-open")&&f[a.id].chat({text:n,attachments:o},r),t("html, body").animate({scrollTop:t(document).height()},100),s.publish({q:{text:n,attachments:o},access_token:a.access_token,user:{username:a.username},chatbot_id:u.lifoidId,lang:i.lang},function(e){for(var n=0;n<e.length;n++)f[e[n].from_user].chat(e[n].payload,e[n].date),n==e.length-1&&t.ajax({url:i.url+"/speech/chatbot/"+u.lifoidId+"/lang/"+i.lang+"/tts",crossDomain:!0,type:"POST",data:JSON.stringify({q:{text:e[n].payload.text},access_token:a.access_token,chatbot_id:u.lifoidId,user:{username:a.username}}),contentType:!1,processData:!1,success:function(t){var e=document.createElement("audio");e.controls=!0,e.autoplay=!0;var a=function(t){for(var e=window.atob(t),a=e.length,n=new Uint8Array(a),i=0;i<a;i++)n[i]=e.charCodeAt(i);return n}(t.audio).buffer,n=new Blob([a],{type:"audio/mpeg"}),i=URL.createObjectURL(n);e.src=i,e.addEventListener("ended",function(){e.currentTime=0,"function"==typeof callback&&console.log("audio playback ended")}),h.children().last().find(".message").append(e),console.log(e)}});t("html, body").animate({scrollTop:t(document).height()},100)},l)};t(".chatitem").click(function(){console.log("chatitem"),d(0,i,t(this).html())}),h.on("click",".lifoid-qr",function(){valueSelected=t(this).attr("data-value"),this.parentNode.remove(),d(0,i,valueSelected)}),h.on("change",".lifoid-ms",function(){t("option:selected",this);var e=this.value;t(".lifoid-ms").remove(),d(0,i,e)}),h.on("click",".send-table",function(){var t=h.find(".lifoid-edit-table"),e=t.tableToJSON({ignoreColumns:[0],textDataOverride:"data-value"});d(0,i,t.attr("data-title"),[{table:{title:t.attr("data-title"),name:t.attr("data-name"),rows:e,columns:t.attr("data-columns").split(",")}}]),h.find(".panel").remove(),t.remove(),this.parentNode.remove()}),h.on("validate","table td",function(e,a){var n=t(this).index();return"Numeric"===h.find(".lifoid-edit-table").attr("data-types").split(",")[n-1]?!isNaN(parseFloat(a))&&isFinite(a):!!a&&a.trim().length>0}),e.empty().append(p),t("#"+u.textFormId).submit(function(){var e=t('input[type="text"]');return e.val()&&(d(0,i,e.val()),e.val(""),t(".lifoid-ms").remove(),t(".lifoid-qr").remove()),!1}),t("#record").click(function(){o++%2==0?(t(this).removeClass("btn-primary"),t(this).addClass("btn-danger"),navigator.getUserMedia_=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia_({audio:!0},function(e){a=e,(n=new MediaStreamRecorder(a)).mimeType="audio/wav",n.sampleRate=44100,n.audioChannels=1,n.ondataavailable=function(e){var a=new FormData;a.append("file",e),a.append("data",JSON.stringify({access_token:i.access_token,chatbot_id:u.lifoidId,user:{username:i.username}})),this.stop(),t.ajax({url:i.url+"/speech/chatbot/"+u.lifoidId+"/lang/"+i.lang+"/stt",crossDomain:!0,type:"POST",data:a,contentType:!1,processData:!1,success:function(t){var e;try{e=t.results[0].alternatives[0].transcript}catch(t){e='""'}console.log(JSON.stringify(t,null,2)),d(0,i,e)}})},n.start(6e3)},function(t){console.error("Couldn't connect to user's audio input",t)})):(t(this).removeClass("btn-danger"),t(this).addClass("btn-primary"),n.stop(),a.stop())}),s.load(c,function(e){for(var a=e.length-1;a>=0;a--)if(!(void 0!=b()&&e[a].date<=b()))if(null!=e[a].payload.attachments){for(j=0;j<e[a].payload.attachments.length;j++)"table"in e[a].payload.attachments[j]&&e[a].from_user!=u.lifoidId||e[a].payload.attachments.splice(j,1);f[e[a].from_user].chat(e[a].payload,e[a].date)}else-1==e[a].payload.text.indexOf("chatui-open")&&f[e[a].from_user].chat(e[a].payload,e[a].date);t("html, body").animate({scrollTop:t(document).height()},100),d(0,i,"chatui-open")},l)})}(this,e);return this}}(jQuery);